rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User documents: owner-only access with field validation
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Sales subcollection with comprehensive validation
      match /sales/{saleId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Strict validation on create
        allow create: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.keys().hasAll(['amount', 'date'])
                      && request.resource.data.amount is number
                      && request.resource.data.amount > 0
                      && request.resource.data.date is string
                      && request.resource.data.date.matches('^[0-9]{2}-[0-9]{2}-[0-9]{4}$');
        
        // Validation on update
        allow update: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.amount is number
                      && request.resource.data.amount > 0
                      && request.resource.data.date is string
                      && request.resource.data.date.matches('^[0-9]{2}-[0-9]{2}-[0-9]{4}$');
      }

      // Expenses subcollection with category validation
      match /expenses/{expenseId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Strict validation on create
        allow create: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.keys().hasAll(['amount', 'category', 'description', 'date'])
                      && request.resource.data.amount is number
                      && request.resource.data.amount > 0
                      && request.resource.data.category in ['Rent', 'Utilities', 'Supplies', 'Marketing', 'Transport', 'Other']
                      && request.resource.data.description is string
                      && request.resource.data.description.size() > 0
                      && request.resource.data.date is string
                      && request.resource.data.date.matches('^[0-9]{2}-[0-9]{2}-[0-9]{4}$');
        
        // Validation on update
        allow update: if request.auth != null
                      && request.auth.uid == userId
                      && request.resource.data.amount is number
                      && request.resource.data.amount > 0
                      && request.resource.data.category in ['Rent', 'Utilities', 'Supplies', 'Marketing', 'Transport', 'Other']
                      && request.resource.data.description is string
                      && request.resource.data.description.size() > 0
                      && request.resource.data.date is string
                      && request.resource.data.date.matches('^[0-9]{2}-[0-9]{2}-[0-9]{4}$');
      }
    }
  }
}